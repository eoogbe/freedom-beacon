var FREE=FREE||{};FREE.MainBeacon=function(){function deleteBeacon(){$.get("/beacons/delete",function(data){$('form[name="main-timer-form"]').html(data)})}function beaconSubmitted(e){var form=this;e.preventDefault();$(".flash").text("Loading data...");$(".flash").show();form.submit()}function run(){if($(".deactivate").length>0){var countdowner=FREE.Countdowner;countdowner.init();countdowner.countdown($('input[name="main-timer"]'),deleteBeacon)}else{$('form[name="main-timer-form"]').submit(beaconSubmitted)}}return{init:$.noop,run:run}}();var FREE=FREE||{};FREE.Facebook=function(){function registerLoginHandler(){var loginButton=FREE.LoginButton;loginButton.init();loginButton.registerEventHandlers()}function registerLogoutHandler(){var logoutButton=FREE.LogoutButton;logoutButton.init();logoutButton.registerEventHandlers()}function init(facebook){$.ajaxSetup({cache:true});$.getScript("//connect.facebook.net/en_US/all.js",function(){var friendsList;FB.init({appId:$('input[name="app-id"]').val().slice(1),status:true,cookie:true,xfbml:true});registerLoginHandler();registerLogoutHandler();if($(".friends").length>0){FB.getLoginStatus(function(response){if(response.status==="connected"){friendsList=FREE.FriendsList;friendsList.init();friendsList.loadFriends()}})}})}return{init:init}}();var FREE=FREE||{};FREE.DistanceFlyout=function(){function addCloseHandler(){var closeButton=FREE.CloseButton;closeButton.init();closeButton.registerEventHandlers()}function distanceClicked(e){$(this).siblings(".distance-flyout").show();addCloseHandler()}function registerEventHandlers(){$(".distance-link").click(distanceClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.FriendsList=function(){function showFlash(){$(".flash").text("Loading friends...");$(".flash").show()}function findFriends(users,threads,fbFriends){var friendsFinder=FREE.FriendsFinder;friendsFinder.init(users,threads,fbFriends);return friendsFinder.findFriends()}function registerModuleEventHandlers(module){module.init();module.registerEventHandlers()}function showFriends(friendsHtml){var $friends=$(".friends");$friends.html(friendsHtml);$friends.slideDown();registerModuleEventHandlers(FREE.DistanceFlyout);registerModuleEventHandlers(FREE.FavoriteButton);registerModuleEventHandlers(FREE.InviteLink)}function getUsers(fbFriends,threads){$.getJSON("/users",{requestor:"jquery"},function(data){var friends=findFriends(data.users,threads,fbFriends);friends.hasFriends=friends.freeFriends.length>0||friends.offlineFriends.length>0;$.get("/friends",friends,function(data){showFriends(data)})})}function loadThreads(fbFriends){FB.api("/me/inbox",function(response){var data;if(response.error){console.log(response.error)}else{data={fbFriends:fbFriends,threads:response.data};$.post("/fbFriends",data,function(){getUsers(fbFriends,response.data)})}})}function loadFbFriends(){FB.api("/me/friends?fields=id,name,username",function(response){if(response.error){console.log(response.error)}else{loadThreads(response.data)}})}function loadFriends(){showFlash();$.getJSON("/fbFriends",{format:"json"},function(data){if(data){getUsers(data.fbFriends,data.threads)}else{loadFbFriends()}})}return{init:$.noop,loadFriends:loadFriends}}();var FREE=FREE||{};FREE.FriendsFinder=function(){var users,threads,fbFriends;function hasFriendParticipant(participants,friendId){for(var i=0;i<participants.length;++i){if(participants[i].id===friendId)return true}return false}function getThreadId(friendId){for(var i=0;i<threads.length;++i){if(hasFriendParticipant(threads[i].participants,friendId)){return threads[i].id}}return null}function getFriendUrl(fbFriend){var threadId=getThreadId(fbFriend.id);return threadId?"https://m.facebook.com/messages/read/?tid="+threadId:"https://facebook.com/messages/"+fbFriend.username}function getFreeFriendData(friend,fbFriend){return{friendId:friend.fbId,name:friend.name,url:getFriendUrl(fbFriend),distance:friend.distance,time:friend.time,isFavorite:friend.isFavorite}}function getOfflineFriendData(friend){return{friendId:friend.fbId,name:friend.name,isFavorite:friend.isFavorite}}function addFriend(friends,friend,fbFriend){var friendData;if(friend.isFree){friendData=getFreeFriendData(friend,fbFriend);if(friend.isFavorite){friends.freeFriends.unshift(friendData)}else{friends.freeFriends.push(friendData)}}else{friendData=getOfflineFriendData(friend);if(friend.isFavorite){friends.offlineFriends.unshift(friendData)}else{friends.offlineFriends.push(friendData)}}}function getFriend(fbFriend){for(var i=0;i<users.length;++i){if(users[i].fbId==fbFriend.id)return users[i]}return null}function findFriends(){var friends={freeFriends:[],offlineFriends:[]};$.each(fbFriends,function(idx,fbFriend){var friend=getFriend(fbFriend);if(friend)addFriend(friends,friend,fbFriend)});return friends}function init(u,t,f){users=u;threads=t;fbFriends=f}return{init:init,findFriends:findFriends}}();var FREE=FREE||{};FREE.FavoriteButton=function(){function buttonClicked($parent,url,newButtonKind){var friendId,buttonHtml;friendId=$parent.data("friend-id");$.post(url,{friendId:friendId},function(){buttonHtml='<button class="'+newButtonKind+'-btn" type="button">'+newButtonKind+"</button>";$parent.html(buttonHtml);registerEventHandlers()})}function favoriteClicked(){buttonClicked($(this).parent(),"/favorites","unfavorite")}function unfavoriteClicked(){buttonClicked($(this).parent(),"/favorites/delete","favorite")}function registerEventHandlers(){$(".favorite-btn").click(favoriteClicked);$(".unfavorite-btn").click(unfavoriteClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.InviteLink=function(){var fbFriends;function sendInviteClicked(){var friendId=$(this).data("fb-id");FB.ui({appId:$('input[name="app-id"]').val().slice(1),method:"send",to:friendId,link:"http://freedom-beacon.herokuapp.com"})}function addCloseHandler(){var closeButton=FREE.CloseButton;closeButton.init();closeButton.registerEventHandlers()}function getFbFriendsHtml(fbFriends,$searchResultsHolder){var fbFriendData={fbFriends:fbFriends,format:"html"};$.get("/fbFriends",fbFriendData,function(data){$searchResultsHolder.html(data);$(".send-invite-link").click(sendInviteClicked)})}function sanitizeString(str){return str.replace(/[^A-Za-z]/g,"")}function searchTyped(){var searchText,searchRegexp;searchText=$.trim($('input[name="fbFriends-search"]').val());if(!searchText)return;searchRegexp=new RegExp("^"+sanitizeString(searchText),"i");var searchResults=$.grep(fbFriends,function(friend){return sanitizeString(friend.name).search(searchRegexp)!==-1});getFbFriendsHtml(searchResults,$(".search-results-holder"))}function registerSearchHandler(){$('input[name="fbFriends-search"]').keypress(searchTyped)}function loadFbFriends(){$.getJSON("/fbFriends",{format:"json"},function(data){if(data){fbFriends=data.fbFriends;registerSearchHandler()}else{FB.api("/me/friends",function(response){if(response.error){console.log(response.error)}else{fbFriends=response.data;registerSearchHandler()}})}})}function inviteClicked(){var $inviteFlyout,flyoutHtml;$inviteFlyout=$(this).parent().siblings(".invite-flyout");flyoutHtml='<div class="clearfix">'+'<button class="close-btn pull-right" type="button">'+'<span class="glyphicon glyphicon-remove"></span> '+"close</button></div>"+'<input type="search" role="search" '+'name="fbFriends-search">'+'<div class="search-results-holder"></div>';$inviteFlyout.html(flyoutHtml);$inviteFlyout.show();addCloseHandler();loadFbFriends()}function registerEventHandlers(){$(".invite-link").click(inviteClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.LoginButton=function(){function init(){$('button[name="login"]').prop("disabled",false)}function afterPost(){var url=FREE.Url;url.init();url.redirect("/beacons/create")}function afterWatching(pos){$(".flash").text("Loading data...");$(".flash").show();FB.api("/me",function(response){var data;if(response.error){console.log(response.error)}else{data={fbId:response.id,name:response.name,coords:pos.coords};$.post("/sessions",data,afterPost)}})}function addSessionData(){if("geolocation"in navigator){navigator.geolocation.watchPosition(afterWatching)}}function loginClicked(){FB.getLoginStatus(function(response){if(response.status==="connected"){addSessionData()}else{FB.login(function(response){if(response.authResponse)addSessionData()},{scope:"read_mailbox"})}})}function registerEventHandlers(){$('button[name="login"]').click(loginClicked)}return{init:init,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.LogoutButton=function(){function redirectToHomepage(){var url=FREE.Url;url.init();url.redirect("/")}function logoutClicked(){FB.logout();redirectToHomepage()}function registerEventHandlers(){$('button[name="logout"]').click(logoutClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.Countdowner=function(){var DELAY=1e3;var interval;function tick($timer,done){var min=parseInt($timer.data("min"));var sec=parseInt($timer.data("sec"));if(sec<=0&&min<=0){done()}else{if(sec===0){--min;sec=59}else{--sec}$timer.data("min",min);$timer.data("sec",sec);if(sec<10)sec="0"+sec;$timer.val(min+":"+sec)}}function countdown($timer,done){interval=new FREE.Interval(function(){tick($timer,done)},DELAY);interval.start()}function stop(){interval.stop()}return{init:$.noop,countdown:countdown,stop:stop}}();var FREE=FREE||{};FREE.Interval=function(fn,delay){var timerId=false;this.start=function(){if(!this.isRunning())timerId=setInterval(fn,delay)};this.stop=function(){clearInterval(timerId);timerId=false};this.isRunning=function(){return timerId!==false}};var FREE=FREE||{};FREE.Url=function(){function redirect(url){window.location=url}function getPathname(){return window.location.pathname}function goBack(){history.back(-1)}return{init:$.noop,redirect:redirect,getPathname:getPathname,goBack:goBack}}();var FREE=FREE||{};FREE.CloseButton=function(){function closeClicked(){$(this).parents(".flyout").hide()}function registerEventHandlers(){$(".close-btn").click(closeClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();"use strict";$(document).ready(function(){initializePage()});function initializePage(){var mainBeacon,inviteLink;FREE.Facebook.init();mainBeacon=FREE.MainBeacon;mainBeacon.init();mainBeacon.run();inviteLink=FREE.InviteLink;inviteLink.init();inviteLink.registerEventHandlers()}
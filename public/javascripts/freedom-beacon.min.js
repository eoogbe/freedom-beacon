var FREE=FREE||{};FREE.MainBeacon=function(){function deleteBeacon(){$.get("/beacons/delete",function(data){$('form[name="main-timer-form"]').html(data)})}function run(){if($(".deactivate").length>0){var countdowner=FREE.Countdowner;countdowner.init();countdowner.countdown($('input[name="main-timer"]'),deleteBeacon)}}return{init:$.noop,run:run}}();var FREE=FREE||{};FREE.Facebook=function(){var url;function afterPost(){url.redirect("/beacons/create")}function afterWatching(pos){FB.api("/me",function(response){var data;if(response.error){console.log(response.error)}else{data={fbId:response.id,name:response.name,coords:pos.coords};$.post("/sessions",data,afterPost)}})}function addSessionData(){if("geolocation"in navigator){navigator.geolocation.watchPosition(afterWatching)}}function loginClicked(){FB.getLoginStatus(function(response){if(response.status==="connected"){addSessionData()}else{FB.login(function(response){if(response.authResponse)addSessionData()},{scope:"read_mailbox"})}})}function logoutClicked(){FB.logout();url.redirect("/")}function init(facebook){$.ajaxSetup({cache:true});$.getScript("//connect.facebook.net/en_US/all.js",function(){var friendsList;FB.init({appId:$('input[name="app-id"]').val().slice(1),status:true,cookie:true,xfbml:true});$('button[name="login"]').prop("disabled",false);$('button[name="login"]').click(loginClicked);$('button[name="logout"]').click(logoutClicked);if($(".friends").length>0){FB.getLoginStatus(function(response){if(response.status==="connected"){friendsList=FREE.FriendsList;friendsList.init();friendsList.loadFriends()}})}});url=FREE.Url;url.init()}return{init:init}}();var FREE=FREE||{};FREE.DistanceFlyout=function(){function addCloseHandler(){var closeButton=FREE.CloseButton;closeButton.init();closeButton.registerEventHandlers()}function distanceClicked(e){$(this).siblings(".distance-flyout").show();addCloseHandler()}function registerEventHandlers(){$(".distance-link").click(distanceClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.FriendsList=function(){function getFreeFriendData(friend,fbFriend){return{friendId:friend.userId,name:friend.name,fbUsername:fbFriend.username,distance:friend.distance,time:friend.time,isFavorite:friend.isFavorite}}function getOfflineFriendData(friend){return{friendId:friend.userId,name:friend.name,isFavorite:friend.isFavorite}}function addFriend(friends,friend,fbFriend){var friendData;if(friend.isFree){friendData=getFreeFriendData(friend,fbFriend);if(friend.isFavorite){friends.freeFriends.unshift(friendData)}else{friends.freeFriends.push(friendData)}}else{friendData=getOfflineFriendData(friend);if(friend.isFavorite){friends.offlineFriends.unshift(friendData)}else{friends.offlineFriends.push(friendData)}}}function getFriend(users,fbFriend){for(var i=0;i<users.length;++i){if(users[i].fbId==fbFriend.id)return users[i]}return null}function findFriends(users,fbFriends){var friends={freeFriends:[],offlineFriends:[]};$.each(fbFriends,function(idx,fbFriend){var friend=getFriend(users,fbFriend);if(friend)addFriend(friends,friend,fbFriend)});return friends}function registerModuleEventHandlers(module){module.init();module.registerEventHandlers()}function showFriends(friendsHtml){var $friends=$(".friends");$friends.html(friendsHtml);$friends.slideDown();registerModuleEventHandlers(FREE.DistanceFlyout);registerModuleEventHandlers(FREE.FavoriteButton);registerModuleEventHandlers(FREE.InviteLink)}function getUsers(fbFriends){$.getJSON("/users",{requestor:"jquery"},function(data){var friends=findFriends(data.users,fbFriends);friends.hasFriends=friends.freeFriends.length>0||friends.offlineFriends.length>0;$.get("/friends",friends,function(data){showFriends(data)})})}function loadFriends(){FB.api("/me/friends?fields=id,name,username",function(response){if(response.error){console.log(response.error)}else{getUsers(response.data)}})}return{init:$.noop,loadFriends:loadFriends}}();var FREE=FREE||{};FREE.FavoriteButton=function(){function buttonClicked($parent,url,newButtonKind){var friendId,buttonHtml;friendId=$parent.data("friend-id");$.post(url,{friendId:friendId},function(){buttonHtml='<button class="'+newButtonKind+'-btn" type="button">'+newButtonKind+"</button>";$parent.html(buttonHtml);registerEventHandlers()})}function favoriteClicked(){buttonClicked($(this).parent(),"/favorites","unfavorite")}function unfavoriteClicked(){buttonClicked($(this).parent(),"/favorites/delete","favorite")}function registerEventHandlers(){$(".favorite-btn").click(favoriteClicked);$(".unfavorite-btn").click(unfavoriteClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.InviteLink=function(){var fbFriends;function sendInviteClicked(){var friendId=$(this).data("fb-id");FB.ui({appId:$('input[name="app-id"]').val().slice(1),method:"send",to:friendId,link:"http://freedom-beacon.herokuapp.com"})}function addCloseHandler(){var closeButton=FREE.CloseButton;closeButton.init();closeButton.registerEventHandlers()}function getFbFriendsHtml(fbFriends,$searchResultsHolder){$.get("/fbFriends",{fbFriends:fbFriends},function(data){$searchResultsHolder.html(data);$(".send-invite-link").click(sendInviteClicked)})}function sanitizeString(str){return str.replace(/[^A-Za-z]/g,"")}function searchTyped(){var searchText,searchRegexp,searchResults;searchText=$.trim($('input[name="fbFriends-search"]').val());if(!searchText)return;searchRegexp=new RegExp("^"+sanitizeString(searchText),"i");searchResults=$.grep(fbFriends,function(friend){return sanitizeString(friend.name).search(searchRegexp)!==-1});getFbFriendsHtml(searchResults,$(".search-results-holder"))}function inviteClicked(){var $inviteFlyout,flyoutHtml;$inviteFlyout=$(this).parent().siblings(".invite-flyout");FB.api("/me/friends",function(response){if(response.error){console.log(response.error)}else{flyoutHtml='<div class="clearfix"><button class="close-btn pull-right" type="button">'+'<span class="glyphicon glyphicon-remove"></span> '+"close</button></div>"+'<input type="search" role="search" '+'name="fbFriends-search">'+'<div class="search-results-holder"></div>';fbFriends=response.data;$inviteFlyout.html(flyoutHtml);$inviteFlyout.show();addCloseHandler();$('input[name="fbFriends-search"]').keyup(searchTyped)}})}function registerEventHandlers(){$(".invite-link").click(inviteClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.Countdowner=function(){var DELAY=1e3;var interval;function tick($timer,done){var min=parseInt($timer.data("min"));var sec=parseInt($timer.data("sec"));if(sec<=0&&min<=0){done()}else{if(sec===0){--min;sec=59}else{--sec}$timer.data("min",min);$timer.data("sec",sec);if(sec<10)sec="0"+sec;$timer.val(min+":"+sec)}}function countdown($timer,done){interval=new FREE.Interval(function(){tick($timer,done)},DELAY);interval.start()}function stop(){interval.stop()}return{init:$.noop,countdown:countdown,stop:stop}}();var FREE=FREE||{};FREE.Interval=function(fn,delay){var timerId=false;this.start=function(){if(!this.isRunning())timerId=setInterval(fn,delay)};this.stop=function(){clearInterval(timerId);timerId=false};this.isRunning=function(){return timerId!==false}};var FREE=FREE||{};FREE.Url=function(){function redirect(url){window.location=url}function getPathname(){return window.location.pathname}function goBack(){history.back(-1)}return{init:$.noop,redirect:redirect,getPathname:getPathname,goBack:goBack}}();var FREE=FREE||{};FREE.CloseButton=function(){function closeClicked(){$(this).parents(".flyout").hide()}function registerEventHandlers(){$(".close-btn").click(closeClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();"use strict";$(document).ready(function(){initializePage()});function initializePage(){var mainBeacon;FREE.Facebook.init();mainBeacon=FREE.MainBeacon;mainBeacon.init();mainBeacon.run()}
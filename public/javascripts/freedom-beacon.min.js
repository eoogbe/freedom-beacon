var FREE=FREE||{};FREE.MainBeacon=function(){function deleteBeacon(){$.get("/beacons/delete",function(data){$('form[name="main-timer-form"]').html(data)})}function showFlash(){$(".flash").text("Loading data...");$(".flash").show()}function illuminatedBeaconSubmitted(e){var form=this;e.preventDefault();showFlash();$.getJSON("/beacons/show",function(data){var min,sec,timeSpent;if(!$.isEmptyObject(data)){min=$('input[name="main-timer"]').data("min");sec=$('input[name="main-timer"]').data("sec");timeSpent=data.duration-min;if(sec>0)--timeSpent;ga("send","timing","beacon","duration",timeSpent)}ga("send","event","beacon","deactivate");form.submit()})}function deactivatedBeaconSubmitted(e){var form=this,timeSet;e.preventDefault();showFlash();timeSet=$('input[name="main-beacon"]').val();ga("send","event","beacon","illuminate");ga("send","timing","beacon","time set",timeSet);form.submit()}function run(){var countdowner;if($(".deactivate").length>0){countdowner=FREE.Countdowner;countdowner.init($('input[name="main-timer"]'),deleteBeacon);if($(".alt-c").length===0){countdowner.countdown()}else{countdowner.countdownC()}$('form[name="main-timer-form"]').submit(illuminatedBeaconSubmitted)}else{$('form[name="main-timer-form"]').submit(deactivatedBeaconSubmitted)}}return{init:$.noop,run:run}}();var FREE=FREE||{};FREE.Facebook=function(){function registerLoginHandler(){var loginButton=FREE.LoginButton;loginButton.init();loginButton.registerEventHandlers()}function registerLogoutHandler(){var logoutButton=FREE.LogoutButton;logoutButton.init();logoutButton.registerEventHandlers()}function init(facebook){$.ajaxSetup({cache:true});$.getScript("//connect.facebook.net/en_US/all.js",function(){var friendsList;FB.init({appId:$('input[name="app-id"]').val().slice(1),status:true,cookie:true,xfbml:true});registerLoginHandler();registerLogoutHandler();if($(".friends").length>0){FB.getLoginStatus(function(response){if(response.status==="connected"){friendsList=FREE.FriendsList;friendsList.init();friendsList.loadFriends()}})}})}return{init:init}}();var FREE=FREE||{};FREE.DistanceFlyout=function(){function addCloseHandler(){var closeButton=FREE.CloseButton;closeButton.init();closeButton.registerEventHandlers()}function distanceClicked(e){$(this).siblings(".distance-flyout").show();addCloseHandler()}function registerEventHandlers(){$(".distance-link").click(distanceClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.FriendsList=function(){function showFlash(){$(".flash").text("Loading friends...");$(".flash").show()}function findFriends(users,threads,fbFriends){var friendsFinder=FREE.FriendsFinder;friendsFinder.init(users,threads,fbFriends);return friendsFinder.findFriends()}function registerModuleEventHandlers(module){module.init();module.registerEventHandlers()}function showFriends(friendsHtml){var $friends=$(".friends");$friends.html(friendsHtml);$friends.slideDown();registerModuleEventHandlers(FREE.DistanceFlyout);registerModuleEventHandlers(FREE.FavoriteButton);registerModuleEventHandlers(FREE.MessageButton);registerModuleEventHandlers(FREE.InviteLink)}function getUsers(fbFriends){$.getJSON("/users",{requestor:"jquery"},function(data){var users,friends;users=data.users?data.users:[];friends=findFriends(users,fbFriends);friends.hasFriends=friends.freeFriends.length>0||friends.offlineFriends.length>0;$.get("/friends",friends,function(data){showFriends(data);$(".flash").hide()})})}function loadFbFriends(){FB.api("/me/friends?fields=id,name,username",function(response){if(response.error){console.log(response.error)}else{getUsers(response.data)}})}function loadFriends(){showFlash();loadFbFriends()}return{init:$.noop,loadFriends:loadFriends}}();var FREE=FREE||{};FREE.FriendsFinder=function(){var users,fbFriends;function getFreeFriendData(friend,fbFriend){return{friendId:friend.fbId,name:friend.name,distance:friend.distance,time:friend.time,isFavorite:friend.isFavorite}}function getOfflineFriendData(friend){return{friendId:friend.fbId,name:friend.name,isFavorite:friend.isFavorite}}function addFriend(friends,friend,fbFriend){var friendData;if(friend.isFree){friendData=getFreeFriendData(friend,fbFriend);if(friend.isFavorite){friends.freeFriends.unshift(friendData)}else{friends.freeFriends.push(friendData)}}else{friendData=getOfflineFriendData(friend);if(friend.isFavorite){friends.offlineFriends.unshift(friendData)}else{friends.offlineFriends.push(friendData)}}}function getFriend(fbFriend){for(var i=0;i<users.length;++i){if(users[i].fbId==fbFriend.id)return users[i]}return null}function findFriends(){var friends={freeFriends:[],offlineFriends:[]};$.each(fbFriends,function(idx,fbFriend){var friend=getFriend(fbFriend);if(friend)addFriend(friends,friend,fbFriend)});return friends}function init(u,f){users=u;fbFriends=f}return{init:init,findFriends:findFriends}}();var FREE=FREE||{};FREE.FavoriteButton=function(){function buttonClicked(url,newButtonKind){var $parent,friendId,buttonHtml;$parent=$(this).parents("li");friendId=$parent.data("friend-id");$.post(url,{friendId:friendId},function(){buttonHtml='<button class="'+newButtonKind+'-btn btn btn-default" type="button">'+newButtonKind+"</button>";$parent.html(buttonHtml);registerEventHandlers()})}function favoriteClicked(){buttonClicked("/favorites","unfavorite")}function unfavoriteClicked(){buttonClicked("/favorites/delete","favorite")}function registerEventHandlers(){$(".favorite-btn").click(favoriteClicked);$(".unfavorite-btn").click(unfavoriteClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.MessageButton=function(){function showFlash(){$(".flash").text("Loading data...");$(".flash").show()}function goToMessage(msgUrl){var urlNav=FREE.Url;urlNav.init();urlNav.redirect(msgUrl)}function hasFriendParticipant(participants,friendId){for(var i=0;i<participants.length;++i){if(participants[i].id===friendId)return true}return false}function getThreadId(threads,friendId){for(var i=0;i<threads.length;++i){if(hasFriendParticipant(threads[i].to,friendId)){return threads[i].id}}return null}function loadThreads(friendId){FB.api("/me/inbox",function(response){var threadId;if(response.error){console.log(response.error)}else{threadId=getThreadId(response.data,friendId);if(threadId){goToMessage("https://m.facebook.com/messages/read/?tid="+threadId)}else{getUsername(friendId)}}})}function getUsername(fbId){FB.api("/"+fbId,function(response){var msgUrl;if(response.error){console.log(response.error)}else{msgUrl="https://facebook.com/messages/"+response.username;goToMessage(msgUrl)}})}function messageClicked(){var friendId=$(this).parents("li").data("friend-id");FB.login(function(response){showFlash();if(response.authResponse){loadThreads(friendId)}else{getUsername(friendId)}},{scope:"read_mailbox"})}function registerEventHandlers(){$(".msg-btn").click(messageClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.InviteLink=function(){var fbFriends;function sendInviteClicked(){var friendId=$(this).data("fb-id");FB.ui({appId:$('input[name="app-id"]').val().slice(1),method:"send",to:friendId,link:"http://freedom-beacon.herokuapp.com"})}function addCloseHandler(){var closeButton=FREE.CloseButton;closeButton.init();closeButton.registerEventHandlers()}function getFbFriendsHtml(fbFriends){var fbFriendData={fbFriends:fbFriends,format:"html"};$.get("/fbFriends",fbFriendData,function(data){$(".search-results-holder").html(data);$(".send-invite-link").click(sendInviteClicked)})}function sanitizeString(str){return str.replace(/[^A-Za-z]/g,"")}function searched(){var searchText,searchRegexp,searchResults;searchText=$.trim($('input[name="fbFriends-search"]').val());if(!searchText)return;searchRegexp=new RegExp("^"+sanitizeString(searchText),"i");searchResults=$.grep(fbFriends,function(friend){return sanitizeString(friend.name).search(searchRegexp)!==-1});getFbFriendsHtml(searchResults)}function registerSearchHandler(){$('input[name="fbFriends-search"]').on("input",searched)}function loadFbFriends(){FB.api("/me/friends",function(response){if(response.error){console.log(response.error)}else{fbFriends=response.data;registerSearchHandler()}})}function inviteClicked(){var $inviteFlyout=$(this).parent().siblings(".invite-flyout");$.get("/invites",function(data){$inviteFlyout.html(data);$inviteFlyout.show();addCloseHandler();loadFbFriends()})}function registerEventHandlers(){$(".invite-link").click(inviteClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.LoginButton=function(){function init(){$('button[name="login"]').prop("disabled",false)}function showFlash(){$(".flash").text("Loading data...");$(".flash").show()}function afterPost(){var url=FREE.Url;url.init();url.redirect("/beacons/create")}function loadFbData(coords){FB.api("/me",function(response){var data;if(response.error){console.log(response.error)}else{data={fbId:response.id,name:response.name,coords:coords};$.post("/sessions",data,afterPost)}})}function afterWatching(pos){showFlash();loadFbData(pos.coords)}function loginWithoutLocation(){showFlash();loadFbData(null)}function addSessionData(){if("geolocation"in navigator){navigator.geolocation.watchPosition(afterWatching,loginWithoutLocation)}else{loginWithoutLocation()}}function loginClicked(){FB.getLoginStatus(function(response){if(response.status==="connected"){addSessionData()}else{FB.login(function(response){if(response.authResponse)addSessionData()})}})}function registerEventHandlers(){$('button[name="login"]').click(loginClicked)}return{init:init,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.LogoutButton=function(){function redirectToHomepage(){var url=FREE.Url;url.init();url.redirect("/")}function logoutClicked(){FB.logout();redirectToHomepage()}function registerEventHandlers(){$('button[name="logout"]').click(logoutClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();var FREE=FREE||{};FREE.Countdowner=function(){var DELAY,DELAY_C,interval,$timer,done;DELAY=1e3;DELAY_C=DELAY*60;function init($t,d){$timer=$t;done=d}function tick(){var min,sec;min=parseInt($timer.data("min"));sec=parseInt($timer.data("sec"));if(sec<=0&&min<=0){done()}else{if(sec===0){--min;sec=59}else{--sec}$timer.data("min",min);$timer.data("sec",sec);if(sec<10)sec="0"+sec;$timer.val(min+":"+sec)}}function tickC(){var min=parseInt($timer.data("min"));if(min<=0){done()}else{--min;$timer.data("min",min);$timer.val(min)}}function countdownImpl(delay,tickFn){interval=new FREE.Interval(tickFn,delay);interval.start()}function countdown(){countdownImpl(DELAY,tick)}function countdownC(){countdownImpl(DELAY_C,tickC)}function stop(){interval.stop()}return{init:init,countdown:countdown,countdownC:countdownC,stop:stop}}();var FREE=FREE||{};FREE.Interval=function(fn,delay){var timerId=false;this.start=function(){if(!this.isRunning())timerId=setInterval(fn,delay)};this.stop=function(){clearInterval(timerId);timerId=false};this.isRunning=function(){return timerId!==false}};var FREE=FREE||{};FREE.Url=function(){function redirect(url){window.location=url}function getPathname(){return window.location.pathname}function goBack(){history.back(-1)}return{init:$.noop,redirect:redirect,getPathname:getPathname,goBack:goBack}}();var FREE=FREE||{};FREE.CloseButton=function(){function closeClicked(){$(this).parents(".flyout").hide()}function registerEventHandlers(){$(".close-btn").click(closeClicked)}return{init:$.noop,registerEventHandlers:registerEventHandlers}}();"use strict";$(document).ready(initializePage);function initializePage(){var mainBeacon,inviteLink;FREE.Facebook.init();mainBeacon=FREE.MainBeacon;mainBeacon.init();mainBeacon.run();inviteLink=FREE.InviteLink;inviteLink.init();inviteLink.registerEventHandlers()}